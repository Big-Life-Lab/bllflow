---
title: "Helper and utility functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Healper and utility functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  % \VignetteDepends{survival}
  % \VignetteDepends{dplyr}
  % \VignetteDepends{magrittr}
  
---

## Introduction

### Metadata

_bllFlow_ supports metadata from DDI and from the R packages hmisc and rjlabelled.

#### DDI metadata
The [Data Documentation Intitiatve](https://www.ddialliance.org) (DDI) is is an 
international standard for describing the data produced by surveys and other 
observational methods in the social, behavioral, economic, and health sciences.

```
Get the description of the study data from DDI and add the description to 
bllFlow object

```{r}
library(survival)
data(pbc)
library(bllFlow)
```

Example 1: First, read the DDI xml file for your data.
```{r}
pbcDDI <- ReadDDI(file.path(getwd(), "../inst/extdata/test-folder/DDI"), "pbcDDI.xml")
```
Metadata is stored in two approaches....

Rusty -  it shows variable and value label lists
All DDI metadata is brought into the `pbcDDI` object. For example, variable labels can be accessed as follows:
```{r}
pbcDDI$variableMetaData
```

Get the varialbe metadata for variableDetails sheet from DDI and add 
that the bllFlow MSW-DDI object.
```{r}
variables <- read.csv(file.path('../inst/extdata/PBC/PBC - variables.csv'))
variableDetails <- read.csv(file.path(getwd(), 'inst/extdata/test-folder/DDI/PBC - variableDetails.csv'))

pbcModel <- BLLFlow(pbc, variables, variableDetails, pbcDDI)
```

Example 2: Write MSW-DDI to MSW.csv
```{r}
WriteDDIPopulatedMSW(pbcModel, "inst/extdata/PBC/vignette-testing/", "testing.csv")
```
creates a directory and file (if they don't already exists. testing.csv will be overwritten if exists.
New/overwrite file. testing.csv contains a `variablesDetail` file with current MSW variableDetails and all labels in the `variablesDetails` (variable and categories) from the DDI.xml file. 

WriteDDIPopulatedMSW(pbcDDI, "inst/extdata/PBC/vignette-testing/", "testing.csv", "newName.csv")
Creates a new file ('newName.csv`) from an existing variableDetails.csv without need for a BLLFlow object.

```

# General utily functions 
(These functions could already be in DDIwR?). Four functions.

getDDIdescription(DDIPath = ddiPath, DDIFile = ddiFile)
# same as calling BLLFlow(pbc, getDDI = c(ddiPath, ddiFile, "description"), but 
would not add the info to the bllFlow object.

Example 3: general utility.
```{r}
pbcDDI <- ReadDDI(file.path(getwd(), "inst/extdata/test-folder/DDI"), "pbcDDI.xml")
CCHS_DDI <- ReadDDI(file.path(getwd(), "inst/extdata/test-folder/DDI"), "cchs-82M0013-E-2013-2014-Annual-component.xml")

varsForCCHS <- GetDDIVariables(CCHS_DDI, c("DHHGAGE", "DHH_SEX"))
No header info, but all the info.

descrForCCHS <- GetDDIHeader(CCHS_DDI)

```
This needs a newPoRT-MSW file to be there in order to populate from ddi otherwise it will not work
```{r}
WriteDDIPopulatedMSW(CCHS_DDI, "inst/extdata/PBC/vignette-testing/", "newPoRT-MSW", "newName.csv")
reports an error.
```
creates a new MSW-variableDetails sheet called "newPort-variableDetails.csv" 
with one variable: DHHAGE

