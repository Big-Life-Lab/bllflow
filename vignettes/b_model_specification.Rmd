---
title: "1 - Specifying your model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{1 - Specifying your model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## Introduction
The Model Specification Workbook (MSW) is used to specify your model. The MSW is 
a series of four worksheets (CSV files) that describe different model components. 
You can use **bllflow** without a MSW but we recommend using the 
`variables` and `variable_details` worksheets. 
 
## The four MSW worksheets
1) `modelDescription` --- the name of the model, date created and other 
information about the study.
1) `variables` --- all model variables, including data cleaning and 
transformations. `variables` is the most important sheet and is helpful even if you don't use other parts of _bllflow_
1) `variableDetails` --- information on factors (categories) and how to transform
 final variables from their starting variables. 
1) `summaryVariables` -- variables that are used in model reporting, such as 
for `Table 1`. 

## Getting stated with the Model Specification Worksheets.
You have your study data. Great. The first step is specifying which variables you 
need in your model, as well as variables for study cohort creation, data cleaning and variable transformation. 

_bllflow_ has example Model Specification Work sheets for the `pbc` data and the 
vignette shows how to recreate a survival model for [primary biliary cirrhosis](https://aasldpubs.onlinelibrary.wiley.com/doi/pdf/10.1002/hep.1840100102). However, the specific work for many model types. 

We emphasize pre-specified analyses but 
variables can be added as you perform study. However, any additional 
variables and transformation be added to the MSW to ensure reproducibilty and 
transparency. The MSW is a record of how you created your model and what analyses
 you performed. As well, _bllflow_ uses metadata throughout the workflow. 

## Examples of the Model Specification Worksheets
The model the we will develop has six variables or predictors: age, sex, bili, albumin, protime, edema. The `variables.csv` contains each variable as row. The sheet includes additional information such as variable labels. There are instructions for data cleaning that are discussed in step 3. For example, the model is restricted to ages 40 to 70 years. So, for `age` there there are `min` and `max` values. 

```{r} 
library(DT)

dt <- read.csv(system.file("extdata", "PBC/PBC-variables.csv", package = "bllFlow"))
datatable(dt, options = list(pageLength = 6))
```

There are two approaches to creating the MSW. We usually start the MSW as a CSV 
file to facilate collaboration -- and this approached is used throughout the 
vignettes. Alternatively, you can create the MSW as an R dataframe.

As well, not all information needs to manually added to the MSW sheets. _bllFlow_ supports importing metadata from:
- DDI (xml) documents;
- variable lablels in study dataframe as `attr` label (using hmisc, sjlabelled or
similar packages); or,
- manually added added to the MSW.

The best approach is to use DDI file [Data Document Initiative](https://www.ddialliance.org) to add labels, units, type, variableType and other metadata. [Helper and utility functions](vignettes/i_helper_functions.Rmd) shows examples of adding DDI metadata to the MSW. 

## Importing the MSW worksheets
MSW worksheets are imported and added to a _BLLFlow_ object that can be used instructions for data cleaning. In the following example, the MSW `variables` and `variableDetails` sheets are read and then added with the `pbc` data into our `pbcModel`.

```{r}
library(survival)
data(pbc) # pbc survival data

# Read variables and variableDetails sheet for the PBC model
variables <- read.csv(file.path(getwd(), 'bllFlow/extdata/PBC/PBC-variables.csv'))
#variableDetailsSheet <- read.csv(file.path(getwd(), 'bllFlow/extdata/PBC/PBC-variableDetails.csv'))

```

```{r}
# pbc data for examples and vignettes
library(survival)
data(pbc)
```

```{r}
# Create a bllFlow R object for the PBC model using the above variables as args
# pbcModel <- BLLFlow(pbc, variablesSheet, variableDetailsSheet)

#Read in the MSW and variable_details sheet for the PBC model
#modelDescription <- read.csv(file.path(getwd(),..
#variables <- read.csv(file.path(getwd(), 'bllFlow/extdata/PBC/PBC - variables.csv'))
#variableDetails <- read.csv(file.path(getwd(), 'bllFlow/extdata/PBC/PBC - variable_details.csv'))
```

# Create a bllFlow R object for the PBC model using the above variables as args
library(bllFlow)
pbcModel <- BLLFlow(pbc, variablesSheet, variableDetailsSheet)
```
**bllFlow** also supports the use of DDI documents. If available, bllFlow labels 
and other information to the `variables.csv` and `variablesCetails.csv`, as well
as perserving data information to support data provenance. 



The Model Specification Workbook (MSW) is the central document creating your 
model using _bllflow_. 
Worksheets within the MSW contain both the names of the starting variables in the original study 
data and the final variables, if variable are transformed. 
- **variables.csv** - Each row in the `variables.csv` file is a variable in your model. 
The columns include variable labels, type, and other information such as which 
variables are transformed (centered, have dummy variables, restrictive cubic 
splines, have interaction terms, etc.).
- **variablesCetails.csv** - includes the details of each variable, including all 
category (factor) levels and labels. Also included are  specific variable transformation 
rules.
- **modelCescription.csv** - includes information such as the model name, outcome, 
model, creator(s), date and data set names.
- **tableCescription.csv** - includes specifications for how to create Table 1 
and other tables.


